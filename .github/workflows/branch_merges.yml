name: CI/CD Pipeline for Branch Merges

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, dev]

jobs:
  branch-validation:
    name: Validate Branch Compatibility
    runs-on: ubuntu-latest
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ PR –∏–¥—ë—Ç –≤ main –∏–ª–∏ dev
    if: github.base_ref == 'main' || github.base_ref == 'dev'
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –≤–µ—Ç–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–∏
    steps:
      - name: Check branch compatibility
        id: validate
        run: |
          TARGET=${{ github.base_ref }}
          SOURCE=${{ github.head_ref }}
          echo "‚û°Ô∏è Target branch: $TARGET"
          echo "‚¨ÖÔ∏è Source branch: $SOURCE"
          
          if [[ "$TARGET" == "main" && "$SOURCE" != "dev" ]]; then
            echo "‚ùå PR from '$SOURCE' to 'main' is not allowed. Only 'dev' can be merged into 'main'."
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [[ "$TARGET" == "dev" && ! "$SOURCE" =~ ^(feature/.*|feat/.*|bugfix/.*)$ ]]; then
            echo "‚ùå PR from '$SOURCE' to 'dev' is not allowed. Only feature/* or bugfix/* can be merged into 'dev'."
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Branch compatibility check passed."
          echo "valid=true" >> $GITHUB_OUTPUT

  # Job –¥–ª—è –ª–∏–Ω—Ç–∏–Ω–≥–∞
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    needs: branch-validation
    if: needs.branch-validation.outputs.valid == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          #install-mode: goinstall
          version: latest
          args: --timeout=5m --verbose
          skip-cache: false

  # Job –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: branch-validation
    if: needs.branch-validation.outputs.valid == 'true'

    strategy:
      matrix:
        go-version: ['1.25']
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Run comprehensive tests
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage report
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage.html

  # Job –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [branch-validation, lint, test]
    if: needs.branch-validation.outputs.valid == 'true'

    strategy:
      matrix:
        go-version: ['1.25']
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Build application
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤
          mkdir -p dist
          
          # –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          echo "üî® Building main application..."
          go build -o dist/jira-parser -v -ldflags="-s -w" ./cmd/jira-parser/main.go
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–∏–Ω–∞—Ä–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω
          if [ -f dist/jira-parser ]; then
            echo "‚úÖ Build successful!"
            ls -la dist/
          else
            echo "‚ùå Build failed!"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: application-binary
          path: dist/
          retention-days: 7
